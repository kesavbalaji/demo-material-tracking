<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Segment Tracking System</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        #qrCode {
            width: 100mm;
            height: 100mm;
        }
        .print-content {
            text-align: center;
        }
        .highlight {
            background-color: #ffff99 !important;
        }
        #loadingIcon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        #printArea {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #qrCodeContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #printButton {
            margin-top: 10px;
        }
        footer {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            position: relative;
        }
        @media print {
            body {
                margin: 0;
                font-family: Arial, sans-serif;
                text-align: center;
            }
            .print-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh; /* Full viewport height */
                margin: 0;
                padding: 0;
            }
            #qrCode {
                margin-bottom: 20px; /* Space between QR code and text */
            }
            #printButton {
                display: none; /* Hide the button during print */
            }
            footer {
                display: none; /* Hide the footer during print */
            }
            #segmentId, #printDate {
                font-size: 50pt; /* Increase font size for Segment ID and Date */
            }
            @page {
                size: auto;
                margin: 0;
            }
        }
    </style>
</head>
<body>
<div id="loadingIcon">
    <img th:src="@{/images/loading-icon.jpg}" alt="Loading...">
</div>
<div class="container mt-5">
    <header class="header print-header">
        <div class="container">
            <h1>Barcode Label Generation</h1>
        </div>
    </header>
    <!-- CSV Upload Form -->
    <form id="uploadForm" class="mb-3">
        <div class="form-group">
            <label for="csvFile">Upload:</label>
            <input type="file" id="csvFile" class="form-control-file" accept=".csv">
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    <table id="entityTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
        <tr>
            <th>ID</th>
            <th>Segment Barcode Id</th>
            <th>Casting Date</th>
            <th>Location</th>
            <th>Reference Level</th>
            <th>Family</th>
            <th>Family Type</th>
            <th>Type</th>
            <th>Length</th>
            <th>Volume</th>
            <th>Print</th> <!-- Print Button Column -->
            <th>Delete</th> <!-- Delete Button Column -->
        </tr>
        </thead>
        <tbody>
        <!-- Data will be populated here -->
        </tbody>
    </table>
    <!-- QR Code display area -->
    <div id="qrCodeContainer" class="mt-5">
        <div id="printArea" class="print-content">
            <div id="qrCode"></div>
            <div id="segmentId" class="mt-3"></div>
            <div id="printDate" class="mt-1"></div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        var table = $('#entityTable').DataTable({
            "data": [],
            "columns": [
                { "data": "id" },
                { "data": "segmentBarcodeId" },
                { "data": "castingDate" },
                { "data": "location" },
                { "data": "referenceLevel" },
                { "data": "family" },
                { "data": "familyType" },
                { "data": "type" },
                { "data": "length" },
                { "data": "volume" },
                {
                    "data": null,
                    "defaultContent": '<button class="btn btn-primary print-row">Print</button>',
                    "orderable": false
                },
                {
                    "data": null,
                    "defaultContent": '<button class="btn btn-danger delete-row">Delete</button>',
                    "orderable": false
                } // Delete button column
            ]
        });

        $('#entityTable tbody').on('click', 'button.print-row', function() {
            // Remove highlight from all rows
            $('#entityTable tbody tr').removeClass('highlight');

            // Get the data for the clicked row
            var row = $(this).closest('tr');
            var data = table.row(row).data();

            // Highlight the clicked row
            row.addClass('highlight');

            // Check print count before proceeding to print
            checkPrintCountAndPrint(data, row);
        });

        $('#entityTable tbody').on('click', 'button.delete-row', function() {
            var row = $(this).closest('tr');
            var data = table.row(row).data();

            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '/materialTracking/api/entities/delete', // Adjust the endpoint as necessary
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        id: data.id
                    }),
                    success: function(response) {
                        alert('Record deleted successfully');
                        table.row(row).remove().draw(); // Remove the row from the table
                    },
                    error: function(error) {
                        alert('Failed to delete record');
                    }
                });
            }
        });

        $('#uploadForm').on('submit', function(event) {
            event.preventDefault();
            var fileInput = document.getElementById('csvFile');
            if (fileInput.files.length === 0) {
                alert("Please select a file to upload.");
                return;
            }
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            $.ajax({
                url: '/materialTracking/api/entities/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function() {
                    $('#loadingIcon').show();
                },
                success: function(response) {
                    alert('Data uploaded successfully');
                    table.clear().rows.add(response).draw();
                },
                error: function(error) {
                    alert('Failed to upload data');
                },
                complete: function() {
                    $('#loadingIcon').hide();
                }
            });
        });

        window.addEventListener('beforeunload', function (e) {
            var confirmationMessage = 'Are you sure you want to leave this page?';
            (e || window.event).returnValue = confirmationMessage; // Gecko + IE
            return confirmationMessage; // Webkit, Safari, Chrome
        });
    });

    function checkPrintCountAndPrint(data, row) {
        $.ajax({
            url: '/materialTracking/api/entities/checkPrintCount', // Adjust the endpoint as necessary
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                segmentBarcodeId: data.segmentBarcodeId
            }),
            success: function(response) {
                if (response === true) { // Check if response is true
                    generateQRCode(data);
                    printQRCode(data);

                    // Hide the row after printing
                    setTimeout(function() {
                        row.remove(); // This removes the row from the table
                    }, 500); // Delay to ensure print dialog is opened before hiding the row
                } else {
                    alert('No duplicates allowed');
                }
            },
            error: function(error) {
                console.log('Failed to check print count');
            }
        });
    }

    function generateQRCode(data) {
        var qrText = `${data.segmentBarcodeId}`;
        $('#qrCode').empty(); // Clear previous QR code

        new QRCode(document.getElementById("qrCode"), {
            text: qrText,
            width: 378, // 100mm in pixels (378 pixels for 100mm assuming 96 DPI)
            height: 378, // 100mm in pixels (378 pixels for 100mm assuming 96 DPI)
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H // Higher error correction level
        });

        // Display Segment ID and Date
        $('#segmentId').text(`${data.segmentBarcodeId}`);
        $('#printDate').text(`${data.castingDate}`);
    }

    function printQRCode(data) {
        var qrCodeHTML = `
            <div class="print-content">
                <div id="qrCode" style="width: 100mm; height: 100mm;"></div>
                <div id="segmentId" style="font-size: 30pt;">${data.segmentBarcodeId}</div>
                <div id="printDate" style="font-size: 30pt;">${data.castingDate}</div>
            </div>
        `;

        var printWindow = window.open('', '', 'height=600,width=800');

        printWindow.document.open();
        printWindow.document.write(`
            <html>
            <head>
                <style>
                    @media print {
                        body {
                            margin: 0;
                            font-family: Arial, sans-serif;
                            text-align: center;
                        }
                        .print-content {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            height: 100vh; /* Full viewport height */
                            margin: 0;
                            padding: 0;
                        }
                        #qrCode {
                            margin-bottom: 20px; /* Space between QR code and text */
                            width: 80mm; /* Ensure QR code is 100mm */
                            height: 80mm; /* Ensure QR code is 100mm */
                        }
                        #printButton {
                            display: none; /* Hide the button during print */
                        }
                        footer {
                            display: none; /* Hide the footer during print */
                        }
                        #segmentId, #printDate {
                            font-size: 50pt; /* Increase font size for Segment ID and Date */
                        }
                        @page {
                            size: auto;
                            margin: 0;
                        }
                    }
                </style>
            </head>
            <body>
                ${qrCodeHTML}
            </body>
            </html>
        `);
        printWindow.document.close();

        // Generate the QR code for the print window
        new QRCode(printWindow.document.getElementById("qrCode"), {
            text: `${data.segmentBarcodeId}`,
            width: 340, // 90mm in pixels (378 pixels for 100mm assuming 96 DPI)
            height: 340, // 90mm in pixels (378 pixels for 100mm assuming 96 DPI)
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H // Higher error correction level
        });

        printWindow.print();

        // AJAX request to update the print status and print count
        $.ajax({
            url: '/materialTracking/api/entities/updatePrintStatus', // Adjust the endpoint as necessary
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                segmentBarcodeId: data.segmentBarcodeId,
                printStatus: 'Printed',
                printCount: 1
            }),
            success: function(response) {
                console.log('Print status updated successfully');
            },
            error: function(error) {
                console.log('Failed to update print status');
            }
        });
    }
</script>
</body>
</html>
