<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receive Confirmation</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        .highlight-green {
        background-color: lightgreen !important;
        }
        .highlight-red {
        background-color: lightcoral !important;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Receive Confirmation</h2>
    <form id="searchForm">
        <div class="form-group">
            <label for="barcode">Scan Segment ID:</label>
            <input type="text" class="form-control" id="barcode">
        </div>
        <div class="form-group">
            <label for="dispatch">Dispatch Id:</label>
            <input type="text" class="form-control" id="dispatch" readonly>
        </div>
        <div class="form-group">
            <label for="segmentBarcodeId">Segment Barcode ID:</label>
            <input type="text" class="form-control" id="segmentBarcodeId" readonly>
        </div>
        <div class="form-group">
            <label for="location">Location:</label>
            <input type="text" class="form-control" id="location" readonly>
        </div>
        <div class="form-group">
            <label for="familyType">Family Type:</label>
            <input type="text" class="form-control" id="familyType" readonly>
        </div>
        <button type="submit" class="btn btn-primary">Confirm</button>
        <button type="reset" class="btn btn-secondary">Clear</button>
        <span id="rowCount" class="ml-3" style="font-size: 1.2em; font-weight: bold;">COUNT: 0/0</span>
    </form>
    <table class="table table-striped table-bordered mt-4" id="resultTable" style="width:100%">
        <thead>
        <tr>
            <th>SI.No</th>
            <th>Segment Barcode ID</th>
        </tr>
        </thead>
        <tbody>
        <!-- Results will be inserted here -->
        </tbody>
    </table>
</div>
<script>
    $(document).ready(function() {
        // Function to update the row count
        function updateRowCount() {
            const rowCount = $('#resultTable tbody tr').length;
            const greenCount = $('#resultTable tbody tr.highlight-green').length;
            $('#rowCount').text('Count: ' + greenCount + '/' + rowCount);
        }

        // Function to highlight rows
        function highlightRows(foundBarcode) {
            $('#resultTable tbody tr').each(function() {
                const segmentBarcodeId = $(this).find('td').eq(1).text();
                if (segmentBarcodeId === foundBarcode) {
                    $(this).addClass('highlight-green').removeClass('highlight-red');
                }
            });
            updateRowCount();
            $('#barcode').val('');
        }

        // Function to populate fields with segment data
        function populateFields(segment) {
            $('#segmentBarcodeId').val(segment.segmentBarcodeId);
            $('#location').val(segment.location);
            $('#familyType').val(segment.familyType);
        }

        $('#barcode').on('keypress', function(e) {
            if (e.which == 13) { // Enter key pressed
                e.preventDefault(); // Prevent default action
                const barcode = $('#barcode').val();
                let segmentFound = false;

                $('#resultTable tbody tr').each(function() {
                    const segmentBarcodeId = $(this).find('td').eq(1).text();
                    if (segmentBarcodeId === barcode) {
                        segmentFound = true;
                    }
                });

                if (!segmentFound) {
                    $.ajax({
                        url: '/materialTracking/api/getDispatchIdBySegmentId/' + barcode,
                        method: 'GET',
                        success: function(response) {
                            if (response.dispatchId) {
                                // Populate the dispatch ID field with the retrieved dispatch ID
                                $('#dispatch').val(response.dispatchId);

                                // Fetch all segments related to the dispatch ID
                                $.ajax({
                                    url: '/materialTracking/api/getReceiveConfirmationByDispatchId/' + response.dispatchId,
                                    method: 'GET',
                                    success: function(segments) {
                                        $('#resultTable tbody').empty(); // Clear existing table rows
                                        let siNo = 1; // Initialize SI.No starting value

                                        segments.forEach((segment) => {
                                            $('#resultTable tbody').append(
                                                `<tr>
                                                    <td>${siNo++}</td> <!-- Increment SI.No for each row -->
                                                    <td>${segment.segmentBarcodeId}</td>
                                                </tr>`
                                            );

                                            // Populate fields with the data of the segment matching the barcode
                                            if (segment.segmentBarcodeId === barcode) {
                                                populateFields(segment);
                                            }
                                        });
                                        highlightRows(barcode); // Highlight rows based on the scanned barcode
                                        updateRowCount(); // Update row count
                                        $('#barcode').val(''); // Clear Scan Segment ID field
                                    },
                                    error: function() {
                                        alert('Error retrieving segments for the dispatch ID.');
                                        $('#barcode').val(''); // Clear Scan Segment ID field
                                    }
                                });

                            } else {
                                alert('Dispatch ID not found for the given segment ID.');
                                $('#barcode').val(''); // Clear Scan Segment ID field
                            }
                        },
                        error: function() {
                            alert('Error retrieving dispatch ID.');
                            $('#barcode').val(''); // Clear Scan Segment ID field
                        }
                    });
                } else {
                    highlightRows(barcode); // Highlight rows if segment already exists in table
                    $('#barcode').val(''); // Clear Scan Segment ID field
                }
            }
        });

        $('#searchForm').on('submit', function(e) {
    e.preventDefault(); // Prevent form submission

    // Collect segment IDs from the table
    let segmentIds = [];
    $('#resultTable tbody tr').each(function() {
        const segmentBarcodeId = $(this).find('td').eq(1).text();
        segmentIds.push(segmentBarcodeId);
    });

    if (segmentIds.length === 0) {
        alert('No segment IDs found in the table.');
        return;
    }

    const dispatchId = $('#dispatch').val();

    // Send update request to backend
    $.ajax({
        url: '/materialTracking/api/receiveConfirmation',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            dispatchId: dispatchId,
            status: 'QA CONFIRMED',
            segmentIds: segmentIds
        }),
        success: function() {
            alert('All segments moved to Erection Yard');
            // Clear the table and form after successful update
            $('#resultTable tbody').empty();
            $('#searchForm')[0].reset();
            $('#barcode').val(''); // Clear Scan Segment ID field
            updateRowCount(); // Update row count
        },
        error: function() {
            alert('All segments moved to Erection Yard.');
            $('#resultTable tbody').empty();
            $('#searchForm')[0].reset();
            $('#barcode').val(''); // Clear Scan Segment ID field
            updateRowCount();
        }
    });
    });


        // Clear button action
        $('button[type="reset"]').on('click', function() {
            $('#resultTable tbody').empty();
            updateRowCount();
        });
    });
</script>
</body>
</html>