<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Segment History Report</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        #qrCode {
            width: 100mm;
            height: 100mm;
        }
        .print-content {
            text-align: center;
        }
        .highlight {
            background-color: #ffff99 !important;
        }
        #loadingIcon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        #printArea {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #qrCodeContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #printButton {
            margin-top: 10px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 40px; /* Adjusted height */
            background-color: #f1f1f1;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
        }
        .footer img {
            width: 30px;  /* Adjust the width to make the logo smaller */
            height: auto;
            margin-left: 10px;  /* Add spacing between text and image */
        }
        @media print {
            body {
                margin: 0;
                font-family: Arial, sans-serif;
                text-align: center;
            }
            .print-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh; /* Full viewport height */
                margin: 0;
                padding: 0;
            }
            #qrCode {
                margin-bottom: 20px; /* Space between QR code and text */
            }
            #printButton {
                display: none; /* Hide the button during print */
            }
            footer {
                display: none; /* Hide the footer during print */
            }
            #segmentId, #printDate {
                font-size: 50pt; /* Increase font size for Segment ID and Date */
            }
            @page {
                size: auto;
                margin: 0;
            }
        }
    </style>
</head>
<body>
<div id="loadingIcon">
    <img th:src="@{/images/loading-icon.jpg}" alt="Loading...">
</div>
<div class="container mt-5">
    <header class="header print-header">
        <div class="container">
            <h1>Segment History Report</h1>
        </div>
    </header>

    <!-- Search Form -->
    <form id="searchForm" class="mb-3">
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="segmentId1">Segment ID:</label>
                <input type="text" id="segmentId1" class="form-control">
            </div>
            <div class="form-group col-md-4">
                <label for="dispatchId">Dispatch ID:</label>
                <input type="text" id="dispatchId" class="form-control">
            </div>
            <div class="form-group col-md-4">
                <label for="location">Location:</label>
                <select id="location" class="form-control">
                    <option>Select</option>
                    <option value="CASTING YARD">CASTING YARD</option>
                    <option value="ERECTION">ERECTION YARD</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="castingDateFrom">Casting Date From:</label>
                <input type="date" id="castingDateFrom" class="form-control">
            </div>
            <div class="form-group col-md-4">
                <label for="castingDateTo">Casting Date To:</label>
                <input type="date" id="castingDateTo" class="form-control">
            </div>
            <div class="form-group col-md-4">
                <label for="erectionDateFrom">Erection Date From:</label>
                <input type="date" id="erectionDateFrom" class="form-control">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="erectionDateTo">Erection Date To:</label>
                <input type="date" id="erectionDateTo" class="form-control">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    <table id="entityTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
        <tr>
            <th>ID</th>
            <th>Segment Barcode Id</th>
            <th>Casting Date</th>
            <th>Location</th>
            <th>Reference Level</th>
            <th>Family</th>
            <th>Family Type</th>
            <th>Type</th>
            <th>Length</th>
            <th>Volume</th>
            <th>Re-Print</th> <!-- New Print Button Column -->
        </tr>
        </thead>
        <tbody>
        <!-- Data will be populated here -->
        </tbody>
    </table>
    <button type="button" class="btn btn-success" id="exportToExcel">Export to Excel</button>
    <!-- QR Code display area -->
    <div id="qrCodeContainer" class="mt-5">
        <div id="printArea" class="print-content">
            <div id="qrCode"></div>
            <div id="segmentId" class="mt-3"></div>
            <div id="printDate" class="mt-1"></div>
        </div>
    </div>
</div>

<!-- Modal for description -->
<div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="descriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="descriptionModalLabel">Re-Print Reason</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="descriptionForm">
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" class="form-control" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="rowId" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitDescription">Submit</button>
            </div>
        </div>
    </div>
</div>
<footer class="footer">
    <span>PARAMOUNT PRINT PACK</span>
    <img th:src="@{/images/paramount.jpg}" alt="Logo 2">
</footer>

<script>
    $(document).ready(function() {
    var table = $('#entityTable').DataTable({
        "data": [],
        "columns": [
            { "data": null }, // This will be used for the auto-increment ID
            { "data": "segmentBarcodeId" },
            { "data": "castingDate" },
            { "data": "location" },
            { "data": "referenceLevel" },
            { "data": "family" },
            { "data": "familyType" },
            { "data": "type" },
            { "data": "length" },
            { "data": "volume" },
            {
                "data": null,
                "defaultContent": '<button class="btn btn-primary print-row">Re-Print</button>',
                "orderable": false
            }
        ],
        "rowCallback": function(row, data, index) {
            // Set the first column with auto-incremented ID
            $('td:eq(0)', row).html(index + 1);
        }
    });

    $('#exportToExcel').on('click', function() {
        // Collect form data
        var searchData = {
            segmentId: lastSegmentId1,  // Use the stored values
            dispatchId: lastDispatchId,  // Use the stored values
            location: $('#location').val(),
            castingDateFrom: $('#castingDateFrom').val(),
            castingDateTo: $('#castingDateTo').val(),
            erectionDateFrom: $('#erectionDateFrom').val(),
            erectionDateTo: $('#erectionDateTo').val()
        };

        $.ajax({
            url: '/materialTracking/api/entities/search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(searchData),
            success: function(response) {
                // Prepare data for Excel
                var excelData = response.map((row, index) => ({
                    ID: index + 1,
                    'Segment Barcode Id': row.segmentBarcodeId,
                    'Casting Date': row.castingDate,
                    Location: row.location,
                    'Reference Level': row.referenceLevel,
                    Family: row.family,
                    'Family Type': row.familyType,
                    Type: row.type,
                    Length: row.length,
                    Volume: row.volume,
                    Description: row.description,
                    Mark: row.mark,
                    Count: row.count,
                    'Left Corbel Distance': row.leftCorbelDistance,
                    'Right Corbel Distance': row.rightCorbelDistance,
                    'Print Status': row.printStatus,
                    'Print Count': row.printCount,
                    'Dispatch Id':  row.dispatchId,
                    'Location Status': row.locationStatus,
                    'Created Date': row.createdDate,
                    'Reprint Reason': row.reprintReason
                }));

                // Convert JSON data to worksheet
                var worksheet = XLSX.utils.json_to_sheet(excelData);

                // Create a new workbook
                var workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "SegmentHistoryReport");

                // Export workbook to Excel file
                XLSX.writeFile(workbook, 'SegmentHistoryReport.xlsx');
            },
            error: function(error) {
                console.log('Failed to search entities');
            }
        });
    });

    var lastSegmentId1 = '';
    var lastDispatchId = '';

    $('#searchForm').on('submit', function(event) {
        event.preventDefault();

        lastSegmentId1 = $('#segmentId1').val();
        lastDispatchId = $('#dispatchId').val();

        // Collect form data
        var searchData = {
            segmentId: lastSegmentId1,
            dispatchId: lastDispatchId,
            location: $('#location').val(),
            castingDateFrom: $('#castingDateFrom').val(),
            castingDateTo: $('#castingDateTo').val(),
            erectionDateFrom: $('#erectionDateFrom').val(),
            erectionDateTo: $('#erectionDateTo').val()
        };

        $.ajax({
            url: '/materialTracking/api/entities/search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(searchData),
            success: function(response) {
                // Clear previous data
                table.clear();

                // Add new data
                table.rows.add(response).draw();

                // Reset form fields
                $('#segmentId1').val('');
                $('#dispatchId').val('');
            },
            error: function(error) {
                console.log('Failed to search entities');
            }
        });
    });

    // Existing row click event logic remains the same
    $('#entityTable tbody').on('click', 'button.print-row', function() {
        // Remove highlight from all rows
        $('#entityTable tbody tr').removeClass('highlight');

        // Get the data for the clicked row
        var row = $(this).closest('tr');
        var data = table.row(row).data();

        // Highlight the clicked row
        row.addClass('highlight');

        // Open the modal for description input
        $('#descriptionModal').data('rowData', data).modal('show');
    });

    $('#submitDescription').on('click', function() {
        var description = $('#description').val();
        var data = $('#descriptionModal').data('rowData');

        $('#descriptionModal').modal('hide');

        // Check print count and print with description
        checkPrintCountAndPrint(data, description);
    });

    function checkPrintCountAndPrint(data, description) {
        $.ajax({
            url: '/materialTracking/api/entities/checkPrintCount',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                segmentBarcodeId: data.segmentBarcodeId,
                reprintReason: description // Send the reprint reason
            }),
            success: function(response) {
                if (response === true) {
                    generateQRCode(data);
                    printQRCode(data, description);

                    // Hide the row after printing
                    setTimeout(function() {
                        table.row('.highlight').remove().draw();
                    }, 500); // Delay to ensure print dialog is opened before hiding the row
                } else {
                    alert('No duplicates allowed');
                }
            },
            error: function(error) {
                console.log('Failed to check print count');
            }
        });
    }

    function generateQRCode(data) {
        var qrText = `${data.segmentBarcodeId}`;
        $('#qrCode').empty(); // Clear previous QR code

        new QRCode(document.getElementById("qrCode"), {
            text: qrText,
            width: 378,
            height: 378,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        $('#segmentId').text(`${data.segmentBarcodeId}`);
        $('#printDate').text(`${data.castingDate}`);
    }

    function printQRCode(data, description) {
        var qrCodeHTML = `
            <div class="print-content">
                <div id="qrCode" style="width: 100mm; height: 100mm;"></div>
                <div id="segmentId" style="font-size: 30pt;">${data.segmentBarcodeId}</div>
                <div id="printDate" style="font-size: 30pt;">${data.castingDate}</div>
            </div>
        `;

        var printWindow = window.open('', '', 'height=600,width=800');

        printWindow.document.open();
        printWindow.document.write(`
            <html>
            <head>
                <style>
                    @media print {
                        body {
                            margin: 0;
                            font-family: Arial, sans-serif;
                            text-align: center;
                        }
                        .print-content {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            height: 100vh;
                            margin: 0;
                            padding: 0;
                        }
                        #qrCode {
                            margin-bottom: 20px;
                            width: 80mm;
                            height: 80mm;
                        }
                        #printButton {
                            display: none;
                        }
                        footer {
                            display: none;
                        }
                        #segmentId, #printDate {
                            font-size: 50pt;
                        }
                        @page {
                            size: auto;
                            margin: 0;
                        }
                    }
                </style>
            </head>
            <body>
                ${qrCodeHTML}
            </body>
            </html>
        `);
        printWindow.document.close();

        new QRCode(printWindow.document.getElementById("qrCode"), {
            text: `${data.segmentBarcodeId}`,
            width: 321,
            height: 321,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        printWindow.print();

        // AJAX request to update the print status and print count
        $.ajax({
            url: '/materialTracking/api/entities/reprintUpdatePrintStatus',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                segmentBarcodeId: data.segmentBarcodeId,
                printStatus: 'Printed',
                printCount: 1,
                description: description // Send description along with the print status
            }),
            success: function(response) {
                console.log('Print status updated successfully');
            },
            error: function(error) {
                console.log('Failed to update print status');
            }
        });
    }
});
</script>



<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
