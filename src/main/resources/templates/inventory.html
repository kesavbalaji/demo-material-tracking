<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search by Count Type</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Inventory List</h2>
    <div class="form-group">
        <label for="countType">Select Count Type:</label>
        <select class="form-control" id="countType">
            <option value="Total Segment Count">Total Segment Count</option>
            <option value="Total Printed Count">Total Printed Count</option>
            <option value="Total Pending Count">Total Pending Count</option>
            <option value="Total QA Confirmed">Total QA Confirmed</option>
            <option value="Total Dispatch Count">Total Dispatch Count</option>
            <option value="Erection Confirm Count">Erection Confirm Count</option>
            <option value="Erection Completed Count">Erection Completed Count</option>
            <option value="RePrinted Segment">RePrinted Segment</option>
        </select>
    </div>
    <button id="searchBtn" class="btn btn-primary">Search</button>

    <table class="table mt-4">
        <thead>
        <tr>
            <th>S.No</th>
            <th>Count Type</th>
            <th>Count</th>
        </tr>
        </thead>
        <tbody id="resultTable">
        <!-- Results will be populated here -->
        </tbody>
    </table>

    <div id="segmentContainer" class="mt-4" style="display: none;">
        <input type="text" id="searchSegment" class="form-control mb-3" placeholder="Search Segment ID">
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Segment ID</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="segmentTable">
            <!-- Segment IDs will be populated here -->
            </tbody>
        </table>
        <div id="pagination" class="mt-3"></div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('#searchBtn').click(function() {
            const selectedType = $('#countType').val();

            // Clear the result table and hide the segment container before each search
            $('#resultTable').empty();
            $('#segmentContainer').hide();

            // Reset the count to 1 for each new search
            let count = 1;

            // AJAX call to fetch count based on selected type
            $.ajax({
                url: '/materialTracking/api/getCount', // Change this URL to your backend endpoint
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ countType: selectedType }),
                success: function(response) {
                    // Assume response contains the count value
                    $('#resultTable').append(`
                        <tr>
                            <td>${count++}</td>
                            <td>${selectedType}</td>
                            <td><a href="#" class="count-link" data-type="${selectedType}">${response.count}</a></td>
                        </tr>
                    `);
                }
            });
        });

        // Handle click on count to fetch segment IDs
        $(document).on('click', '.count-link', function(e) {
            e.preventDefault();
            const countType = $(this).data('type');

            // Clear the segment table before each new fetch
            $('#segmentTable').empty();

            // AJAX call to fetch segment IDs based on count type
            $.ajax({
                url: '/materialTracking/api/getSegmentIds', // Change this URL to your backend endpoint
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ countType: countType }),
                success: function(response) {
                    console.log(response); // Log the full response
                    populateSegmentTable(response); // Directly pass the response array
                    $('#segmentContainer').show(); // Show the segment ID table
                }
            });
        });

        // Function to populate the segment table with pagination
        function populateSegmentTable(data) {
            if (!Array.isArray(data)) {
                console.error('Invalid data:', data);
                return; // Exit if data is not a valid array
            }

            console.log("Populating table with:", data); // Log the data being passed to the function
            const itemsPerPage = 10;
            const totalPages = Math.ceil(data.length / itemsPerPage);
            let currentPage = 1;

            function renderTable(page) {
                $('#segmentTable').empty(); // Clear existing rows
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedItems = data.slice(start, end);

                paginatedItems.forEach((segment, index) => {
                    $('#segmentTable').append(`
                        <tr>
                            <td>${start + index + 1}</td>
                            <td>${segment.segmentId}</td>
                            <td>${segment.status}</td>
                        </tr>
                    `);
                });
                console.log("Table rendered for page", page); // Log when the table is rendered
            }

            function renderPagination() {
                $('#pagination').empty();
                for (let i = 1; i <= totalPages; i++) {
                    $('#pagination').append(`<button class="btn btn-sm btn-secondary page-btn">${i}</button> `);
                }
            }

            // Initial render
            renderTable(currentPage);
            renderPagination();

            // Handle page button clicks
            $(document).on('click', '.page-btn', function() {
                currentPage = parseInt($(this).text());
                renderTable(currentPage);
            });

            // Handle search in the segment table
            $('#searchSegment').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('#segmentTable tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchTerm) > -1);
                });
            });
        }
    });
</script>


</body>
</html>
