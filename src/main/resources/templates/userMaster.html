<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Master Screen</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2>User Master Screen</h2>
            <button id="newUserBtn" class="btn btn-primary">New</button>
            <button id="editUserBtn" class="btn btn-warning">Edit</button>
        </div>
    </div>

    <!-- New User Section -->
    <div class="row mt-4" id="newUserSection" style="display: none;">
        <div class="col-md-12">
            <h4>Add New Users</h4>
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin Rights</th>
                </tr>
                </thead>
                <tbody id="newUserTableBody">
                <!-- New user rows will be added here -->
                </tbody>
            </table>
            <button id="addNewUserRowBtn" class="btn btn-secondary">Add Row</button>
            <button id="saveNewUsersBtn" class="btn btn-success">Save</button>
        </div>
    </div>

    <!-- Edit User Section -->
    <div class="row mt-4" id="editUserSection" style="display: none;">
        <div class="col-md-12">
            <h4>Edit Users</h4>
            <div class="input-group mb-3">
                <input type="text" id="searchUser" class="form-control" placeholder="Search by Username">
            </div>
            <table class="table table-bordered" id="editUserTable">
                <thead>
                <tr>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin Rights</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <!-- Edit user data from backend will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    // Function to toggle between New and Edit sections
    $('#newUserBtn').click(function() {
        $('#newUserSection').show();
        $('#editUserSection').hide();
        $('#newUserTableBody').empty(); // Clear the new user table
        addNewUserRow(); // Add one default row
    });

    $('#editUserBtn').click(function() {
        $('#newUserSection').hide();
        $('#editUserSection').show();
        loadUsersForEditing(); // Fetch users from backend and populate the table
    });

    // Function to add a new row in the New User table
    function addNewUserRow() {
        const row = `
            <tr>
                <td><input type="text" class="form-control" required></td>
                <td><input type="text" class="form-control" required></td>
                <td>
                    <select class="form-control">
                        <option value="Admin">Admin</option>
                        <option value="Casting">Casting</option>
                        <option value="Erection">Erection</option>
                    </select>
                </td>
            </tr>
        `;
        $('#newUserTableBody').append(row);
    }

    // Add row button in New User section
    $('#addNewUserRowBtn').click(function() {
        addNewUserRow();
    });

    // Save new users to the backend
    $('#saveNewUsersBtn').click(function() {
        const users = [];
        $('#newUserTableBody tr').each(function() {
            const username = $(this).find('input[type="text"]').eq(0).val();
            const password = $(this).find('input[type="text"]').eq(1).val();
            const accessRights = $(this).find('select').val();
            if (username && password && accessRights) {
                users.push({ username, password, accessRights });
            }
        });
        if (users.length > 0) {
            $.ajax({
                url: '/materialTracking/api/users',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(users),
                success: function(response) {
                    alert('Users saved successfully');
                    $('#newUserSection').hide();
                },
                error: function(error) {
                    console.error('Error saving users:', error);
                }
            });
        } else {
            alert('Please fill in all fields');
        }
    });

    // Load users for editing
    function loadUsersForEditing() {
        $.ajax({
            url: '/materialTracking/api/users',
            type: 'GET',
            success: function(response) {
                renderEditUserTable(response);
            },
            error: function(error) {
                console.error('Error fetching users:', error);
            }
        });
    }

    // Render the Edit User table with backend data
    function renderEditUserTable(users) {
        const tbody = $('#editUserTable tbody');
        tbody.empty();
        users.forEach((user) => {
            const row = `
                <tr data-user-id="${user.id}">
                    <td><input type="text" class="form-control" value="${user.username}" readonly></td>
                    <td><input type="text" class="form-control" value="${user.password}" readonly></td>
                    <td>
                        <select class="form-control" disabled>
                            <option value="Admin" ${user.accessRights === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Casting" ${user.accessRights === 'Casting' ? 'selected' : ''}>Casting</option>
                            <option value="Erection" ${user.accessRights === 'Erection' ? 'selected' : ''}>Erection</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-warning editBtn">Edit</button>
                        <button class="btn btn-danger deleteBtn">Delete</button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    // Handle editing user in the Edit User table
    $('#editUserTable').on('click', '.editBtn', function() {
        const row = $(this).closest('tr');
        row.find('input, select').prop('readonly', false);
        row.find('select').prop('disabled', false);
        $(this).removeClass('btn-warning editBtn').addClass('btn-success saveBtn').text('Save');
    });

    // Handle saving changes for a user in the Edit User table
    $('#editUserTable').on('click', '.saveBtn', function() {
        const row = $(this).closest('tr');
        const username = row.find('input[type="text"]').eq(0).val();
        const password = row.find('input[type="text"]').eq(1).val();
        const accessRights = row.find('select').val();
        const userId = row.data('user-id');

        $.ajax({
            url: `/materialTracking/api/users/${userId}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ username, password, accessRights }),
            success: function(response) {
                alert('User updated successfully');
                loadUsersForEditing();
            },
            error: function(error) {
                console.error('Error updating user:', error);
            }
        });
    });

    // Handle deleting user in the Edit User table
    $('#editUserTable').on('click', '.deleteBtn', function() {
        const row = $(this).closest('tr');
        const userId = row.data('user-id');

        $.ajax({
            url: `/materialTracking/api/users/${userId}`,
            type: 'DELETE',
            success: function(response) {
                alert('User deleted successfully');
                loadUsersForEditing();
            },
            error: function(error) {
                console.error('Error deleting user:', error);
            }
        });
    });

    // Search users in Edit table by username in real-time
    $('#searchUser').on('input', function() {
        const value = $(this).val().toLowerCase();
        $('#editUserTable tbody tr').filter(function() {
            $(this).toggle($(this).find('td:first input').val().toLowerCase().indexOf(value) > -1);
        });
    });
</script>
</body>
</html>
